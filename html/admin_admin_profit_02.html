<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
	<link rel="stylesheet" type="text/css" href="../css/jquery.bxslider.css">
	<link rel="stylesheet" type="text/css" href="../css/defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/admin_defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/new_style.css">
	<link rel="stylesheet" type="text/css" href="../css/admin.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="../js/jquery.bxslider.js"></script>
	<script src="../js/function.js"></script>
	<script src="../js/pagination.min.js"></script>
	<script src="../js/admin.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"/>
</head>
<body>
	<div class="container">
		<div class="header_messageLine">
			<div class="header_messageLine_message">
				<span class="message_first">
					온라인 셀러들의 도구,
				</span>
				<span class="message_second">
					헬프스토어 셀러퀸즈
				</span>
			</div>
		</div>
		<div class="admin_m_header">
			<div class="ham">
				<span></span>
				<span></span>
				<span></span>
			</div>
			<a href=""><img src="../image/admin_back.png" alt="" /></a>
			<a href="../html/main.html" class="header_gnb_logo">
				<img src="../image/logo.png">
			</a>
			<div>
				<span>김관리자</span> 님
			</div>
		</div>
		<div class="adminContainer">
			<!-- rightmenu -->
			<div class="rightmenuWrap"></div>
			<div class="adminWrap">
				 <div class="adminWrap_topmenu">
					<ul>
						<li class="active"><a href="./admin_admin_main.html">관리자 센터</a></li>
						<li><a href="./admin_seller_main.html">셀러 센터</a></li>
						<li><a href="./admin_domae_main.html">도매 센터</a></li>
						<li><a href="./admin_teacher_main.html">강사 센터</a></li>
					</ul>
				</div>
				<div class="adminWrap_title">
					<a href="./admin_admin_main.html"><img src="../image/admin_back.png" alt="" /></a>
					<h3>프로핏</h3>
				</div> 
					<div class="adminContent">
						<div class="adminContent_tab">
							<ul>
								<li><a href="./admin_admin_profit_01.html">회원 리스트</a></li>
								<li class="active"><a href="./admin_admin_profit_02.html">출금신청 리스트</a></li>
								<li><a href="./admin_admin_profit_03.html">판매수수료 리스트</a></li>
								<li><a href="./admin_admin_profit_04.html">판매수수료 적립현황</a></li>
								<li><a href="./admin_admin_profit_05.html">광고수수료 적립현황</a></li>
								<li><a href="./admin_admin_profit_06.html">판매수수료 출금 현황</a></li>
								<li><a href="./admin_admin_profit_07.html">광고수수료 출금 현황</a></li>
							</ul>
						</div>
						<div class="adminContent_profit">
							89,000원
						</div>
						<div class="adminContent_search">
							<input type="text" name="search_profit" placeholder="상품을 검색하세요." style="width: calc( 100% - 400px );" onkeyup="enterkey()">
							<select class="check_btn adminContent_search_select">
								<option>판매 프로핏</option>
							</select>
							<a href="javascript:void(0)" class="check_btn search_btn">검색</a>
						</div>
						<div class="adminContent_date">
							<select name="search_year1">
							</select>
							<select  name="search_month1">
							</select>
							<select  name="search_day1">
							</select>
						</div>
						<div class="adminContent_date_middle">
							<b>────</b>
						</div>
						<div class="adminContent_date">
							<select name="search_year2">
							</select>
							<select  name="search_month2">
							</select>
							<select  name="search_day2">
							</select>
						</div>
						<div class="adminContent_date2">
							<select>
								<option>회원등급</option>
							</select>
						</div>

						<div class="adminContent_date2">
							<select>
								<option>정산상태</option>
							</select>
						</div>
						<div class="adminContent_order">
							<a href="javascript:void(0)" class="check_btn confirm_btn" onclick="profit_send()">지급하기</a>
							<a href="javascript:void(0)" class="check_btn" onclick="profit_refund()">회수하기</a>
						</div>
						<div>
							<table class="adminContent_table">
								<colgroup>
									<col width="3%">
									<col width="3%">
									<col width="*">
									<col width="10%">
									<col width="10%">
									<col width="10%">
									<col width="10%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
								</colgroup>
								<thead>
									<th></th>
									<th>No.</th>
									<th>ID</th>
									<th>연락처</th>
									<th>주민등록번호</th>
									<th>이름</th>
									<th>입금은행</th>
									<th>계좌번호</th>
									<th>신청금액</th>
									<th>신청일자</th>
									<th>출금예정일</th>
									<th>진행상태</th>
								</thead>
								<tbody id="withdraw_tbody">
									
								</tbody>
							</table>
						</div>
						<div class="adminContent_pager" id="paging">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>

<script>
	
	var withdraws = [];
	var withdraws_origin = [];
	var user_id = localStorage.getItem('user_id');
    var profit_id_arr = [];

	$(document).ready(function() {
		$('.rightmenuWrap').load('admin_admin_rightmenu.html');
	});
	
	function load_withdraw_list(datas){
		//console.log('datas',datas);
		var tag = ``;

		$.each(datas, function(m, withdraw){
			
			var unix_timestamp = withdraw.enroll_time;
			var date = new Date(unix_timestamp * 1000);
			var hours = date.getHours();
			var minutes = "0" + date.getMinutes();
			var seconds = "0" + date.getSeconds();
			var mon = (date.getMonth()+1);
			var formattedTime = date.getFullYear() + "-" + mon + "-" + date.getDate();	
			
			var stateStr = '';
			if(withdraw.stateStr=="requested"){
				stateStr = "출금요청중";
			}else if(withdraw.stateStr=="confirmed"){
                stateStr = "지급완료";
            }
			
			var bank_name = '';
			if(withdraw.bank == 'sinhan'){
				bank_name = '신한';
			}else{
				bank_name = withdraw.bank;
			}

			 tag += `<tr>
							<td>
								<div class="adminContent_table_checkbox">
                                    <input id="check${withdraw.id}" type="checkbox" name="chk_name" value="${withdraw.id}">
									<label for="check${withdraw.id}"><span></span></label>
								</div>
							</td>
							<td>1</td>
							<td class="adminContent_table_name">
								<p>${withdraw.idStr}</p>
							</td>
							<td>${withdraw.phone}</td>
							<td>${withdraw.resident_number}</td>
							<td>${withdraw.name}</td>
							<td>${bank_name}</td>
							<td>${withdraw.bank_number}</td>
							<td>${withdraw.withdraw_amount.toLocaleString('ko-KR')}원</td>
							<td>${formattedTime}</td>
							<td></td>
							<td>${stateStr}</td>
						</tr>`;
		})


		$("#withdraw_tbody").html(tag);

	}

	$.get("http://43.200.169.89/withdraw-infos-by-seller?seller_id="+user_id,result=>{
		console.log(result);

		withdraws = result;
		withdraws_origin = result;
		
		var time_arr = [];
		$.each(withdraws_origin, function(i, res){
			time_arr.push(res.enroll_time);
		});

		var date2 = new Date(Math.max.apply(null, time_arr) * 1000);
		var mon2 = date2.getMonth()+1;
		var day2 = date2.getDate();

		var date3 = new Date(Math.min.apply(null, time_arr) * 1000);
		var mon3 = date3.getMonth()+1;
		var day3 = date3.getDate();
		console.log(date3);
		$("select[name=search_year1]").val(date3.getFullYear()).prop("selected",true);
		$("select[name=search_month1]").val(mon3).prop("selected",true);
		$("select[name=search_day1]").val(day3).prop("selected",true);
		
		$("select[name=search_year2]").val(date2.getFullYear()).prop("selected",true);
		$("select[name=search_month2]").val(mon2).prop("selected",true);
		$("select[name=search_day2]").val(day2).prop("selected",true);

		$('#paging').pagination({
			dataSource: withdraws,
			callback: function(data, pagination) {
				load_withdraw_list(data);
			}
		});
		
	});
	
	$(".confirm_btn").click(function(e){
		var search_word = $("input[name=search_profit]").val();
		
		withdraws = withdraws_origin.filter(function(withdraw_info){
			return withdraw_info.product_name.indexOf(search_word) > -1;
		})

		$('#paging').pagination({
			dataSource: withdraws,
			callback: function(data, pagination) {
				load_withdraw_list(data);
			}
		});
	})

	$(".search_btn").click(function(e){
		var search_word = $("input[name=search_profit]").val();
		
		withdraws = withdraws_origin.filter(function(withdraw_info){
			return withdraw_info.product_name.indexOf(search_word) > -1;
		})

		$('#paging').pagination({
			dataSource: withdraws,
			callback: function(data, pagination) {
				load_withdraw_list(data);
			}
		});
	})
	
	function enterkey(){
		if (window.event.keyCode == 13) {
			var search_word = $("input[name=search_profit]").val();
		
			withdraws = withdraws_origin.filter(function(withdraw_info){
				return withdraw_info.product_name.indexOf(search_word) > -1;
			})

			$('#paging').pagination({
				dataSource: withdraws,
				callback: function(data, pagination) {
					load_withdraw_list(data);
				}
			});
		}
	}
	
	var selected_date = 0;
	var date_filter = '';
	var selected_date2 = 0;
	var date_filter2 = '';
	var selected_day = 0;
	var selected_day2 = 0;

	$(document).on('change','.date_filter_change',function(){
		selected_day = "0" + $("select[name=search_day1]").val();
		selected_date = $("select[name=search_year1]").val()+'-'+$("select[name=search_month1]").val()+'-'+selected_day.substr(-2);
		//date_filter = (Date.now(selected_date)/1000);
		selected_day2 = "0" + $("select[name=search_day2]").val();
		selected_date2 = $("select[name=search_year2]").val()+'-'+$("select[name=search_month2]").val()+'-'+selected_day2.substr(-2);
		//date_filter2 = (Date.now(selected_date2)/1000);

		withdraws = withdraws_origin.filter(function(info){
			var unix_timestamp = info.enroll_time;
			var date = new Date(unix_timestamp * 1000);
			var mon = "0" + (date.getMonth()+1);
			var day = "0" + (date.getDate());
			var formattedTime = date.getFullYear() + "-" + mon.substr(-2) + "-" + day.substr(-2);
			console.log('formattedTime', formattedTime);
			//console.log('selected_date1',selected_date);
			//console.log('selected_date2',selected_date2);
			return formattedTime >= selected_date && formattedTime <= selected_date2
		})

		$('#paging').pagination({
			dataSource: withdraws,
			callback: function(data, pagination) {
				page_num = pagination.totalNumber - ((pagination.pageNumber-1) * pagination.pageSize);
				load_withdraw_list(data);
			}
		});
		//console.log(withdraws);
	})

    function profit_send(){

        $("input[name=chk_name]:checked").each(function(){
			profit_id_arr.push($(this).val());
		});

		if(profit_id_arr.length == 0){
			alert("대상을 선택해주세요.");
			return false;
		}
        for(var i = 0; i < profit_id_arr.length; i++){
            $.ajax({
                type : "POST",            // HTTP method type(GET, POST) 형식이다.
                url : "http://43.200.169.89/confirm-withdraw",      // 컨트롤러에서 대기중인 URL 주소이다.
                data : {
                    request_id : profit_id_arr[i]
                    },            // Json 형식의 데이터이다.
                success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
                    // 응답코드 > 0000
                    console.log(res);

                    if(res == "success"){
                        alert("프로핏 지급이 완료되었습니다.");
                        location.reload();
                    }else{
                        alert("오류 발생. 관리자에게 문의하세요.");
                    }
                },
                error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
                    alert("통신 실패.")
                }
            });
        }
        
    }
</script>
