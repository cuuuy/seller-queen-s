<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<link rel="stylesheet" type="text/css" href="../css/jquery.bxslider.css">
	<link rel="stylesheet" type="text/css" href="../css/defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/market_style.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="../js/jquery.bxslider.js"></script>
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
	<link rel="stylesheet" href="../js/fontawesome-stars.css">
	<script type="text/javascript" src="../js/jquery.barrating.min.js"></script>
</head>
<body style="background:#ddd;">
	<div class="marketContainer">
		<div class="header">
			<header class="marketHeader">
			<div>
				<a href="./market_review.html"><img src="../image/market_back.png" alt=""></a>
			</div>
			<h2>후기 작성</h2>
			<form method="POST" enctype="multipart/form-data" id="uploadForm">
			<div class="marketHeader_mypage">
				<a href="javascript:void(0);" class="marketHeader_mypage_icon"><img src="../image/market_my.png" alt=""></a>
				<div class="marketHeader_mypage_menu">
					<p class="marketHeader_mypage_menu_close"><img src="../image/market_nav_arrow.png" alt=""></p>
					<div class="marketHeader_mypage_menu_top">
						<span class="marketHeader_mypage_menu_top_profile"></span>
						<h5>김셀럽 회원님, 환영합니다.</h5>
					</div>
					<ul class="marketHeader_mypage_menu_list">
						<li><a href="market_order.html">주문내역</a></li>
						<li><a href="market_cart.html">장바구니</a></li>
						<li><a href="market_review.html">후기 게시판</a></li>
						<li><a href="market_qna.html">문의 게시판</a></li>
						<li><a href="market_see.html">최근 본 상품</a></li>
					</ul>
					<ul class="marketHeader_mypage_menu_logout">
						<li>로그아웃</li>
					</ul>
				</div>
			</div>
		</header>
		</div>
		<div class="marketContent">
			<div class="marketReview marketBoardWrite">
				<h3>레몬트리</h3>
				<h4>마켓 이용은 어떠셨나요?</h4>
				<div class="marketReview_star">
					<!-- <span><img src="../image/gray_star.png" alt="" /></span>
					<span><img src="../image/gray_star.png" alt="" /></span>
					<span><img src="../image/gray_star.png" alt="" /></span>
					<span><img src="../image/gray_star.png" alt="" /></span>
					<span><img src="../image/gray_star.png" alt="" /></span> -->
					<select id="star_point" name="star_point">
						<option value="">0</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
					</select>
				</div>
				<div class="marketReview_write">
					<textarea name="review_text" placeholder="마켓을 이용하면서 좋았던 점과 느낀점을 적어주세요. 관리자와 마켓 이용자에게 도움이 됩니다."></textarea>
					<p>(최소 10자 이상 작성해주세요)</p>
				</div>
				<div class="marketReview_photo">
					<p onclick="$('#main_img').trigger('click')">참고 사진이 있다면 업로드 해주세요</p>
					<p><input type="file" name="main_img" id="main_img" style="display:none;"></p>
				</div>
			</div>
			<div class="marketJoin_btn">
				<a href="javascript:void(0)" class="ok_btn" onclick="review_write()">등록하기</a>
			</div>
		</div>
		</form>
	</div>
</body>


<script>
	var user_id = localStorage.getItem('user_id');
	if(user_id == null){
		user_id = -1; // 비회원
	}

	$(function(){
		$('.marketHeader_mypage_icon').click(function(){
			$('.marketHeader_mypage_menu').animate({
				'right': '0'
			}, 300);
		});
		$('.marketHeader_mypage_menu_close').click(function(){
			$('.marketHeader_mypage_menu').animate({
				'right': '-300px'
			}, 300);
		});

		$('#star_point').barrating({
			theme: 'fontawesome-stars',
			initialRating: 3
		  });
	});
	var now_date = Date.now();
	var enroll_time = now_date/1000;

	var queryString = window.location.search;
	var urlParams = new URLSearchParams(queryString);
	var product_id = urlParams.get('product_id');

	function review_write(){ // 장바구니에 상품 추가 function
		var form_data = new FormData();
		
		var review_point = $("select[name=star_point] option:selected").val();
		var review_text = $("textarea[name=review_text]").val();
		
		if(review_point==0){
			alert("별점을 입력해주세요.");
			return false;
		}

		if(review_text==""){
			alert("내용을 입력해주세요.");
			return false;
		}
		
		form_data.append('user_id',user_id);
		form_data.append('product_id', product_id);
		form_data.append('review_point', review_point);
		form_data.append('review_text', review_text);
		form_data.append('enroll_time', enroll_time);
		
		if($("#main_img").val()==""){
			url = "http://43.200.169.89/enroll-review-no-image";
		}else{
			url = "http://43.200.169.89/enroll-review";
			form_data.append('file', $("#main_img")[0].files[0]);
		}

		$.ajax({
			type : "POST",            // HTTP method type(GET, POST) 형식이다.
			url : url,      // 컨트롤러에서 대기중인 URL 주소이다.
			contentType: false,
			processData: false,
			data : form_data,            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				// 응답코드 > 0000
				console.log(res);

				if(res == "success"){
					alert("리뷰가 등록되었습니다.");
					location.href="market_review.html?product_id="+product_id;
				}else{
					alert("오류 발생. 관리자에게 문의하세요.");
				}
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}
</script>
