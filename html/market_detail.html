<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<link rel="stylesheet" type="text/css" href="../css/jquery.bxslider.css">
	<link rel="stylesheet" type="text/css" href="../css/defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/market_style.css">
	<link rel="stylesheet" type="text/css" href="../css/admin.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="../js/jquery.bxslider.js"></script>
</head>
<body style="background:#ddd;">
	<div class="marketContainer">
		<div class="header"></div>
		<div class="marketContent">
			<div class="marketDetail" id="marketDetail_mainImg">
				<!-- <div class="marketDetail_mainImg" id="marketDetail_mainImg"></div> -->
				<div class="marketDetail_con">
					<div class="marketDetail_con_top">
						<h3 id="product_title"></h3>
						<table id="option_table">
							<tr>
								<th class="marketDetail_top_price">판매가</th>
								<td class="marketDetail_top_price" id="retail_price"></td>
							</tr>
							<!-- <tr>
								<th>COLOR</th>
								<td>
									<select name="" id="">
										<option value="">[선택]</option>
										<option value="">RED</option>
										<option value="">GREEN</option>
									</select>
								</td>
							</tr> -->
						</table>
					</div>
					<div class="marketDetail_fixbox_btn2">
						<!-- <a href="market_cart.html"> -->
						<a href="javascript:void(0)" onclick="market_review();">
							후기작성
						</a>
						<a href="javascript:void(0)" onclick="market_qna();">
							문의하기
						</a>
					</div>
					<div class="marketDetail_con_mid">
						<ul class="marketDetail_con_mid_tab">
							<li class="active" id="marketDetail_tab01">상세 정보</li>
							<li id="marketDetail_tab02">환불정책</li>
							<li id="marketDetail_tab03">교환정책</li>
						</ul>
						
						<!--상세정보-->
						<div class="marketDetail_con_box01">
							<div class="marketDetail_con_box_text">
								<p id="product_descStr">&lt;상품정보&gt;</p><br><br>
								<!-- <p>
									&lt;상품정보&gt;<br><br>
									크기 : 6.9*5.8mm<br>
									색상 : 그린, 핑크<br>
									재질 : 금속, 플라스틱<br><br>
									<img src="../image/product01.png" alt=""><br><br>
									<span>블링블링 티파니앤코 스타일의 팔찌에요!<br>데일리로 귀엽게 착용해보세요~</span>
								</p> -->
							</div>
							<div class="marketDetail_con_btm">
								<ul>
									<li>
										<h4>배송정보</h4>
										<div class="delivery_info">
											
										</div>
									</li>
									<li>
										<h4>상품결제정보</h4>
										<div class="payment_info">
											
										</div>
									</li>
									<li class="marketDetail_con_btm_price">
										<table>
											<tr>
												<th>총 상품금액</th>
												<td id="product_amount">0원</td>
											</tr>
											<tr>
												<th>총 배송비</th>
												<td id="deli_amount">+0원</td>
											</tr>
											<tr>
												<th>최종 주문금액</th>
												<td id="total_amount">0원</td>
											</tr>
										</table>
									</li>
									<li>
										<h4>쇼핑몰 사업자 정보</h4>
                                        <div>
                                            (주)아이제이<br>
                                            대표자 : 신혜원<br>
                                            사업자등록번호 000-00-00000<br>
                                        </div>
									</li>
								</ul>
							</div>
						</div>
						
						<!--환불정책-->
						<div class="marketDetail_con_box02">
							<div class="marketDetail_con_box_text marketDetail_con_box_text2">
								<p>&lt;환불정책&gt;</p>
							</div>
							<div class="marketDetail_con_btm">
								<ul>
									<li>
										<h4>쇼핑몰 사업자 정보</h4>
                                        <div>
                                            (주)아이제이<br>
                                            대표자 : 신혜원<br>
                                            사업자등록번호 000-00-00000<br>
                                        </div>
									</li>
								</ul>
							</div>
						</div>
						
						
						<!--교환정책-->
						<div class="marketDetail_con_box03">
							<div class="marketDetail_con_box_text marketDetail_con_box_text3">
								<p>&lt;교환정책&gt;</p>
							</div>
							<div class="marketDetail_con_btm">
								<ul>
									<li>
										<h4>쇼핑몰 사업자 정보</h4>
                                        <div>
                                            (주)아이제이<br>
                                            대표자 : 신혜원<br>
                                            사업자등록번호 000-00-00000<br>
                                        </div>
									</li>
								</ul>
							</div>
						</div>
						
					</div>
					
				</div>
				<div class="marketDetail_fixbox">
					<div class="marketDetail_fixbox_up_box">
						<a href="javascript:void(0);" class="marketDetail_fixbox_up"></a>
						<div class="marketDetail_fixbox_show">
							<ul>
								<li>
									<h4>배송방법</h4>
									<ul>
										<li class="co777 option1">택배</li>
										<!-- <li class="co777 option1">직접수령</li> -->
									</ul>
								</li>
								<li><h4>배송비</h4>
									<ul class="deli_method">
										<!-- <li class="co777 option2">3,000원</li>
										<li class="co777 option2">5,000원 (제주, 도서지역 추가 2000원)</li> -->
									</ul>
								</li>
								<li id="bottom_option_li"><h4>수량</h4>
									<ul>
										<li class="tac option3"><span class="option3_minus">-</span> &nbsp;&nbsp; <span class="option3_num">1</span> &nbsp;&nbsp; <span class="option3_plus">+</span></li>
									</ul>
								</li>
								<!-- <li><h4>COLOR</h4>
									<ul>
										<li>보라</li>
										<li>연두</li>
										<li>소라</li>
									</ul>
								</li>
								<li><h4>SIZE</h4>
									<ul>
										<li>S</li>
										<li>M</li>
										<li>L</li>
									</ul>
								</li> -->
							</ul>
							<div class="marketDetail_fixbox_up_box_price">
								<p><span class="bottom_count">1</span>개 선택</p>
								<h4>총 <span class="bottom_amount">0원</span></h4>
							</div>
						</div>
					</div>
					<div class="marketDetail_fixbox_btn">
						<!-- <a href="market_cart.html"> -->
						<a href="javascript:void(0)" onclick="add_cart();">
							장바구니
						</a>
						<a href="javascript:void(0)" onclick="move_order();">
							결제하기
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>


<script>
	
	var count = 1;

	$(document).ready(function() {
		localStorage.removeItem('local_data');

		$('.header').load('market_subheader.html');
		
		// 탭 전환
		$('.marketDetail_con_box01').siblings('div').hide();
		$('#marketDetail_tab01').click(function(){
			$('.marketDetail_con_box01').show();
			$('.marketDetail_con_box01').siblings('div').hide();
			$(this).addClass('active');
			$(this).siblings('li').removeClass('active');
		});
		$('#marketDetail_tab02').click(function(){
			$('.marketDetail_con_box02').show();
			$('.marketDetail_con_box02').siblings('div').hide();
			$(this).addClass('active');
			$(this).siblings('li').removeClass('active');
		});
		$('#marketDetail_tab03').click(function(){
			$('.marketDetail_con_box03').show();
			$('.marketDetail_con_box03').siblings('div').hide();
			$(this).addClass('active');
			$(this).siblings('li').removeClass('active');
		});
		
		// 하단 fixbox show
		$('.marketDetail_fixbox_show').hide();
		$('.marketDetail_fixbox_up').click(function(){
			$(this).toggleClass('active');
			$(this).siblings('div').slideToggle(400);
		});
		
		// 드롭다운
		$('.marketDetail_fixbox_show > ul > li > ul').hide()
		$('.marketDetail_fixbox_show > ul > li h4').click(function(){
			//$(this).siblings().slideToggle(400);
			//$(this).parent('li').toggleClass('active');
		});
		
		// 상세정보 드롭다운
		$('.marketDetail_con_btm > ul > li').click(function(){
			$(this).children('div').stop().slideToggle(400);
			$(this).toggleClass('slide');
		});
		
		$(document).on("click",".marketDetail_fixbox_show > ul > li h4", function(){
			$(this).siblings().slideToggle(400);
			$(this).parent('li').toggleClass('active');
		});

		$(document).on("click",".marketDetail_fixbox_up", function(){
			$('.marketDetail_fixbox_show > ul > li > ul').hide()
		});
		$(document).on("click",".option1", function(){
			$(this).addClass('on');
			$(this).siblings().removeClass("on");
		});
		$(document).on("click",".option2", function(){
			$(this).addClass('on');
			$(this).siblings().removeClass("on");
		});

		$(document).on("click",".option3_plus", function(){
			var option3_num = parseInt($(".option3_num").text());
			$(".option3_num").text(option3_num+1);
			$(".bottom_count").text(option3_num+1);
			count = option3_num+1;
			product_load_re_amount();
		});

		$(document).on("click",".option3_minus", function(){
			var option3_num = parseInt($(".option3_num").text());
			
			if(option3_num == 1){
				alert('최소 수량은 1개 입니다.');
				return false;
			}else{
				$(".option3_num").text(option3_num-1);
				$(".bottom_count").text(option3_num-1);
				count = option3_num-1;
				product_load_re_amount();
			}
		});
		

		enroll_user_history();
		product_load();

	});
	var user_id = localStorage.getItem('user_id');
	var test = localStorage.getItem('local_data');

	var now_date = new Date();
	var enroll_time = parseInt(now_date.getTime()/1000);

	var queryString = window.location.search;
	var urlParams = new URLSearchParams(queryString);
	var product_id = urlParams.get('product_id');
	var option_length_arr = [];
	var option_name_arr = [];
	var options_arr = [];
	var option_obj = {};

	if(product_id==null){
		alert("잘못된 접근입니다.");
		location.href="./market_main.html";
	}
	function enroll_user_history(){//최근 본 상품 등록 function
		// ajax 통신
		$.ajax({
			type : "POST",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/enroll-user-history",      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
					user_id : user_id,
					product_id : product_id,
					enroll_time : enroll_time
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				// 응답코드 > 0000
				//console.log(res);
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}

	function add_cart(){ // 장바구니에 상품 추가 function

		for(var i = 0; i < option_length_arr.length; i++){
			var top_option_value = $("select[name=option_name_"+i+"]").val();
			options_arr.push(top_option_value);
		}
		console.log(options_arr);

		if(options_arr.includes("")==true){
			alert("옵션을 선택해주세요.");
			options_arr = [];
			return false;
		}

		var options = [];

		for(var i = 0; i < option_length_arr.length; i++){
			var top_option_key = $("select[name=option_name_"+i+"]").data('key');
			var top_option_value = $("select[name=option_name_"+i+"]").val();

			var option_dict = {};

			option_dict[top_option_key] = top_option_value;
			//option_dict[top_option_value] = top_option_value;

			options.push(option_dict);
		}

		options = JSON.stringify(options);

		//console.log(count);
		//console.log(options);
		//console.log('option_length_arr',option_length_arr);
		//return;
		$.ajax({
			type : "POST",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/add-to-cart",      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
					user_id : user_id,
					product_id : product_id,
					enroll_time : enroll_time,
				    count : count,
				    options : options
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				// 응답코드 > 0000
				console.log(res);

				if(res == "success"){
					alert("장바구니에 상품이 담겼습니다.");
					//location.href="market_sell_ok.html";
				}else{
					alert("오류 발생. 관리자에게 문의하세요.");
				}
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}
	
	function product_load_re_amount(){//가격 재설정
		// ajax 통신
		$.ajax({
			type : "GET",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/retail_product-detail?product_id="+product_id,      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				console.log(res);
				
				//count = 1;
				var sum_price = (res[0].retail_price * count)+res[0].delivery_fee;
				

				$("#retail_price").text((res[0].retail_price * count).toLocaleString('ko-KR')+" 원");
				
				$("#deli_amount").text("+"+res[0].delivery_fee.toLocaleString('ko-KR')+" 원");
				

				$("#product_amount").text((res[0].retail_price * count).toLocaleString('ko-KR')+" 원");
				$(".bottom_amount").text(sum_price.toLocaleString('ko-KR')+" 원");
				$("#total_amount").text(sum_price.toLocaleString('ko-KR')+" 원");
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}

	function product_load(){
		// ajax 통신
		$.ajax({
			type : "GET",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/retail_product-detail?product_id="+product_id,      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				console.log(res);
                
                $(".marketDetail_con_box_text2 > p").append(res[0].refund_info);
                $(".marketDetail_con_box_text3 > p").append(res[0].exchange_info);
                $(".delivery_info").append(res[0].delivery_info);
                $(".payment_info").append(res[0].payment_info);

				var img_path = res[0].main_img_url.replace("public","");
				var new_html = `<div class="marketDetail_mainImg" style="background: url(http://43.200.169.89`+img_path+`) no-repeat; background-size:cover;"></div>`;
				
				count = 1;
				var sum_price = (res[0].retail_price * count)+res[0].delivery_fee;
				
				var tag = `<li class="co777 option2">${res[0].delivery_fee.toLocaleString('ko-KR')} 원</li>`;

				$(".deli_method").append(tag);

				$("#retail_price").text((res[0].retail_price * count).toLocaleString('ko-KR')+" 원");
				$("#product_title").text(res[0].product_name);
				$("#marketDetail_mainImg").prepend(new_html);
				$("#product_amount").text((res[0].retail_price * count).toLocaleString('ko-KR')+" 원");
				$("#deli_amount").text("+"+res[0].delivery_fee.toLocaleString('ko-KR')+" 원");
				$("#total_amount").text(sum_price.toLocaleString('ko-KR')+" 원");
				$("#product_descStr").after(res[0].descStr);

				$(".bottom_amount").text(sum_price.toLocaleString('ko-KR')+" 원");

				var new_html2 = ``;
				var new_html3 = ``;
				var new_html4 = ``;
				var new_html5 = ``;
				
				for(var i = 0; i < res.length; i++){
                    
					var parse_option_key = Object.keys(JSON.parse(res[i].options));
					var parse_option_value = Object.values(JSON.parse(res[i].options));
					
					//console.log(parse_option_key);
					//console.log(parse_option_value);

					for(var j = 0; j < parse_option_value.length; j++){
						option_length_arr.push(parse_option_key);
						//console.log(option_length_arr);
						for(var k = 0; k < parse_option_value[j]['selections'].length; k++){
							//console.log(parse_option_value[j]['selections'][k]);
							new_html3 += `<option class="" value="${parse_option_value[j]['selections'][k]}">${parse_option_value[j]['selections'][k]}</option>`;

							new_html5 += `<li class="co777 cell option_li_${parse_option_value[j].option_name} 2option_li_${parse_option_value[j]['selections'][k]}" value="${parse_option_value[j]['selections'][k]}" data-key="option_name_${parse_option_key[j]}">${parse_option_value[j]['selections'][k]}</li>`;

						}
						new_html2 += `<tr>
								<th>${parse_option_value[j].option_name}</th>
								<td>
									<select name="option_name_${parse_option_key[j]}" class="top_option_value" data-key="${parse_option_value[j].option_name}" data-num="${j}">
										<option value="">[선택]</option>
									${new_html3}	
									</select>
								</td>
							</tr>`;
						new_html4 += `<li>
									<h4 class="option_names_${parse_option_value[j].option_name}">${parse_option_value[j].option_name}</h4>
									<ul>
										${new_html5}
									</ul>
								</li>`;

						new_html3 = ``;
						new_html5 = ``;

						$(document).on("click",".option_li_"+parse_option_value[j].option_name, function(e){
							$(this).addClass('on');
							$(this).siblings().removeClass("on");
						});

					}

				}
				$("#bottom_option_li").after(new_html4);
				$("#option_table").append(new_html2);
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}
	
	$(document).on("click",".cell", function(e){
		var class_key = $(e.target).data('key');
		var class_value = $(e.target).text();
		$("select[name="+class_key+"]").val(class_value);
		
	});
	
	$(document).on("change",".top_option_value", function(e){
		var class_key = $(e.target).data('key');
		var class_value = $(e.target).val();
		$(".2option_li_"+class_value).addClass("on");
	});
	
	
	function move_order(){
		

		if($(".option1.on").text()==""){
			alert("배송방법을 선택해주세요.");
			$(".marketDetail_fixbox_up").addClass('active');
			$(".marketDetail_fixbox_up").siblings('div').slideToggle(400);
			$('.marketDetail_fixbox_show > ul > li > ul').hide();
			return false;
		}

		if($(".option2.on").text()==""){
			alert("배송비를 선택해주세요.");
			return false;
		}

		for(var i = 0; i < option_length_arr.length; i++){
			var top_option_key = $("select[name=option_name_"+i+"]").data('key');
			var top_option_value = $("select[name=option_name_"+i+"]").val();
			
			option_name_arr.push(top_option_key);
			options_arr.push(top_option_value);
		}

		if(options_arr.includes("")==true){
			alert("옵션을 선택해주세요.");
			return false;
		}

		var local_data = {
			"total_amount" : parseInt($("#total_amount").text().replace(" 원","")),
			"price" : parseInt($("#product_amount").text().replace(" 원","")),
			"count" : count,
			"deli_fee" : parseInt($("#deli_amount").text().replace("+","").replace(" 원","")),
			"deli_method" : $(".option1.on").text(),
			"option_name" : option_name_arr,
			"options_arr" : options_arr
		};
		
		console.log(local_data);
		//return;
		localStorage.setItem("local_data", JSON.stringify(local_data));

		if(localStorage.getItem('user_id')){
			location.href="market_sell.html?product_id="+product_id;
		}else{
			location.href="./market_login.html?product_id="+product_id;
		}
	}

	function market_review(){
		location.href="market_review.html?product_id="+product_id;
	}

	function market_qna(){
		location.href="market_qna.html?product_id="+product_id;
	}
	
</script>
