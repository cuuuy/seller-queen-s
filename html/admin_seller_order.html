<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
	<link rel="stylesheet" type="text/css" href="../css/jquery.bxslider.css">
	<link rel="stylesheet" type="text/css" href="../css/defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/admin_defalut.css">
	<link rel="stylesheet" type="text/css" href="../css/new_style.css">
	<link rel="stylesheet" type="text/css" href="../css/style.css">
	<link rel="stylesheet" type="text/css" href="../css/admin.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="../js/jquery.bxslider.js"></script>
	<script src="../js/admin.js"></script>
	<script src="../js/pagination.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"/>
	<script src="../js/function.js"></script>
</head>
<body>
	<div class="container">
		<div class="header_messageLine">
			<div class="header_messageLine_message">
				<span class="message_first">
					온라인 셀러들의 도구,
				</span>
				<span class="message_second">
					헬프스토어 셀러퀸즈
				</span>
			</div>
		</div>
		<div class="admin_m_header">
			<div class="ham">
				<span></span>
				<span></span>
				<span></span>
			</div>
			<a href=""><img src="../image/admin_back.png" alt="" /></a>
			<a href="../html/main.html" class="header_gnb_logo">
				<img src="../image/logo.png">
			</a>
			<div>
				<span>김관리자</span> 님
			</div>
		</div>
		<div class="adminContainer">
			<!-- rightmenu -->
			<div class="rightmenuWrap"></div>
			<div class="adminWrap">
				 <div class="adminWrap_topmenu">
					<ul>
						<li><a href="./admin_admin_main.html">관리자 센터</a></li>
						<li class="active"><a href="./admin_seller_main.html">셀러 센터</a></li>
						<li><a href="./admin_domae_main.html">도매 센터</a></li>
						<li><a href="./admin_teacher_main.html">강사 센터</a></li>
					</ul>
				</div>
				<div class="adminWrap_title">
					<a href=""><img src="../image/admin_back.png" alt="" /></a>
					<h3>주문/발송 관리</h3>
				</div> 
					<div class="adminContent">
						<div class="adminContent_tab">
							<ul>
								<li class="order_count_new active"><a href="javasciprt:void(0)">신규주문 <span class="order_count_new_span"></span></a></li>
								<li class="order_count_ready"><a href="javasciprt:void(0)">입금대기 <span class="order_count_ready_span"></span></a></li>
								<li class="order_count_paid"><a href="javasciprt:void(0)">결제 완료 <span class="order_count_paid_span"></span></a></li>
								<li class="order_count_deli_ready"><a href="javasciprt:void(0)">배송 준비중 <span class="order_count_deli_ready_span"></span></a></li>
								<li class="order_count_deli_complete"><a href="javasciprt:void(0)">발송 완료 <span class="order_count_deli_complete_span"></span></a></li>
								<li class="order_count_all"><a href="javasciprt:void(0)">전체 <span class="order_count_all_span"></span></a></li>
							</ul>
						</div>
						<div class="adminContent_search adminContent_search_long">
							<input type="text" name="search_order" placeholder="상품명을 검색하세요." onkeyup="enterkey()">
							<!-- <a href="javascript:void(0)" class="check_btn" onclick="modal_popup2();">송장입력</a> -->
							<a href="javascript:void(0)" class="check_btn search_btn">검색</a>
						</div>
						<div class="adminContent_date">
							<select name="search_year1">
							</select>
							<select  name="search_month1">
							</select>
							<select  name="search_day1">
							</select>
						</div>
						<div class="adminContent_date_middle">
							<b>────</b>
						</div>
						<div class="adminContent_date">
							<select name="search_year2">
							</select>
							<select  name="search_month2">
							</select>
							<select  name="search_day2">
							</select>
						</div>
						<div>
							<table class="adminContent_table">
								<colgroup>
									<col width="3%">
									<col width="3%">
									<col width="*">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
									<col width="8%">
								</colgroup>
								<thead>
									<th></th>
									<th>No.</th>
									<th>상품명</th>
									<th>판매가</th>
									<th>도매처</th>
									<th>상태</th>
									<th>재고</th>
									<th>구매일자</th>
									<th>배송비</th>
									<th>최종 금액</th>
									<th>택배사</th>
									<th>송장</th>
									<th>주문</th>
								</thead>
								<tbody id="order_load_tbody">
									
								</tbody>
							</table>
						</div>
						<div class="adminContent_pager" id="paging">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 완료 -->
	<input type="hidden" name="order_view_id">
	<div id="modal" class="adminModal modalPage04 modal-overlay" style="display:none;background: rgba(0,0,0,0.4);">
		<!-- <div class="adminModal_ok adminModal_order">
			<h3>주문서 내역</h3>
			<div>
				<table class="adminModal_order_table">
				   <colgroup>
					 <col width="20%">
					 <col width="*">
				   </colgroup>
				   <tbody>
						<tr>
					   		<th>상품명</th>
					   		<td id="order_view_product_name"></td>
						</tr>
						<tr>
					   		<th>옵션</th>
					   		<td id="order_view_option">S/노랑</td>
						</tr>
						<tr>
					   		<th>수량</th>
					   		<td id="order_view_product_count"></td>
						</tr>
						<tr>
					   		<th>판매가</th>
					   		<td id="order_view_price"></td>
						</tr>
						<tr>
					   		<th>배송료</th>
					   		<td id="order_view_delivery_fee"></td>
						</tr>
						<tr>
					   		<th>셀러이름</th>
					   		<td id="order_view_seller_name"></td>
						</tr>
						<tr>
					   		<th>구매날짜</th>
					   		<td id="order_view_sell_date"></td>
						</tr>
						<tr>
					   		<th>구매자명</th>
					   		<td id="order_view_sell_name"></td>
						</tr>
						<tr>
					   		<th>주소</th>
					   		<td id="order_view_addr"></td>
						</tr>
						<tr>
					   		<th>송장번호</th>
					   		<td id="order_view_invoice_num"></td>
						</tr>
				   </tbody>
				</table>
				
			</div>
			<div class="adminModal_ok_btn">
				<a href="javascript:void(0);" class="ok_btn modalClose" id="close_btn">확인</a>
			</div>
		</div> -->
	</div>
	
	<input type="hidden" name="invoice_id">
	<div id="modal2" class="adminModal modal-overlay" style="display:none;">
		<div class="adminModal_ok adminModal_invoice">
			<h3>송장입력</h3>
			<div>
				<div>
					<h5>택배사</h5>
					<select name="delivery_company_name">
						<option value="cj">cj 대한통운</option>
						<option value="rozen">로젠</option>
						<option value="woo">우체국</option>
					</select>
				</div>
				<div>
					<h5>송장번호</h5>
					<input type="text" name="invoice_number" placeholder="">
				</div>
			</div>
			<div class="adminModal_ok_btn">
				<a href="javascript:void(0)" id="close_btn2" class="ok_btn modalClose" onclick="invoice_save()">확인</a>
			</div>
		</div>
	</div>
</body>

</html>

<script>

	var orders = [];
	var orders_origin = [];
	var products = [];
	var invoices = [];

	$(document).ready(function() {
		$('.rightmenuWrap').load('admin_seller_rightmenu.html');

		order_load();
		invoice_load();
	});
	
	var now_date = Date.now();
	var enroll_time = now_date/1000;

	function modal_popup(id){
		const modal = document.getElementById("modal")
		modal.style.display = "flex"
		$("input[name=order_view_id]").val(id);
	}

	const modal = document.getElementById("modal")
	const closeBtn = modal.querySelector(".close-area")
	const close_btn = modal.querySelector("#close_btn")

	//close_btn.addEventListener("click", e => {
	//	modal.style.display = "none"
	//})

	//closeBtn.addEventListener("click", e => {
	//	modal.style.display = "none"
	//})

	modal.addEventListener("click", e => {
		const evTarget = e.target
		if(evTarget.classList.contains("modal-overlay")) {
			modal.style.display = "none"
		}
	})

	window.addEventListener("keyup", e => {
		if(modal.style.display === "flex" && e.key === "Escape") {
			modal.style.display = "none"
		}
	})

	function modal_popup2(id){
		const modal2 = document.getElementById("modal2")
		modal2.style.display = "flex"
		$("input[name=invoice_id]").val(id);
	}

	const modal2 = document.getElementById("modal2")
	const closeBtn2 = document.querySelector(".close-area2")
	const close_btn2 = modal2.querySelector("#close_btn2")
	
	//close_btn2.addEventListener("click", e => {
	//	modal2.style.display = "none"
	//})

	//closeBtn2.addEventListener("click", e => {
	//	modal2.style.display = "none"
	//})

	modal2.addEventListener("click", e => {
		const evTarget = e.target
		if(evTarget.classList.contains("modal-overlay")) {
			modal2.style.display = "none"
		}
	})

	window.addEventListener("keyup", e => {
		if(modal2.style.display === "flex" && e.key === "Escape") {
			modal2.style.display = "none"
		}
	})
	
	$(document).on("click", ".modalClose", function () {
		$("#modal").hide();
	  });

	function load_order_list(datas){
		//console.log('datas',datas);
		var tag = ``;
		var tag2 = ``;
		
		var order_count_new = 0;
		var order_count_ready = 0;
		var order_count_paid = 0;
		var order_count_deli_ready = 0;
		var order_count_deli_complete = 0;
		var order_count_all = 0;

		for(var i = 0; i < datas.length; i++){
			
			var product = product_load(datas[i].product_id);
			//var invoice = invoice_load(datas[i].id);

			var unix_timestamp = datas[i].order_time;
			var date = new Date(unix_timestamp * 1000);
			var hours = date.getHours();
			var minutes = "0" + date.getMinutes();
			var seconds = "0" + date.getSeconds();
			var mon = (date.getMonth()+1);
			var formattedTime = date.getFullYear() + "-" + mon + "-" + date.getDate();

			var img_path = product['data'].main_img_url.replace("public","");
			var product_sum = datas[i].product_price + datas[i].delivery_fee;
			
			var statusStr = '';
			if(datas[i].statusStr == 'paid'){
				statusStr = '결제완료';
			}else if(datas[i].statusStr == 'ready'){
				statusStr = '입금대기';
			}else if(datas[i].statusStr == 'returned'){
				statusStr = '반품';
			}else if(datas[i].statusStr == 'readyForReturn'){
				statusStr = '수거지시';
			}else if(datas[i].statusStr == 'sended'){
				statusStr = '발송완료';
			}else{
				statusStr = datas[i].statusStr;
			}
			
			if(true){// 신규주문 일때로 변경해야함
				order_count_new = order_count_new + 1;
			}
			if(datas[i].statusStr == 'ready'){
				order_count_ready = order_count_ready + 1;
			}
			if(datas[i].statusStr == 'paid'){
				order_count_paid = order_count_paid + 1;
			}
			if(datas[i].statusStr == 'ready'){// 배송준비중 일때로 변경해야함
				order_count_deli_ready = order_count_deli_ready + 1;
			}
			if(datas[i].statusStr == 'ready'){// 발송완료 일때로 변경해야함
				order_count_deli_complete = order_count_deli_complete + 1;
			}

			
			var img_path = product['data'].main_img_url.replace("public","");
			var product_sum = datas[i].product_price + datas[i].delivery_fee;
			if(datas[i].isShow=="YES"){
				var isShow = "판매중";
			}
			
			var delivery_company_name = '';

			if(datas[i].delivery_company_name == 'cj'){
				delivery_company_name = 'cj 대한통운';
			}else if(datas[i].delivery_company_name == 'rozen'){
				delivery_company_name = '로젠택배';
			}else if(datas[i].delivery_company_name == 'woo'){
				delivery_company_name = '우채국 택배';
			}
					tag+= `<tr>
									<td>
										<div class="adminContent_table_checkbox">
											<input id="check${datas[i].id}" type="checkbox" name="revise_id" value="${datas[i].id}">
											<label for="check${datas[i].id}"><span></span></label>
										</div>
									</td>
									<td>${i+1}</td>
									<td class="adminContent_table_name">
										<span class="adminContent_table_name_thumb" style="background: url(http://43.200.169.89`+img_path+`) no-repeat; background-size:cover;"></span>
										<p>${product['data'].product_name}</p>
									</td>
									<td>${datas[i].product_price.toLocaleString('ko-KR')}원</td>
									<td></td>
									<td>${statusStr}</td>
									<td>${product['data'].remain_count}</td>
									<td>${formattedTime}</td>
									<td>${datas[i].delivery_fee.toLocaleString('ko-KR')}원</td>
									<td>${product_sum.toLocaleString('ko-KR')}원</td>
									<td>${delivery_company_name}</td>
									<td>
										<div class="adminContent_order">
											<a href="javascript:void(0);" class="check_btn" onclick="modal_popup2(${datas[i].id});">송장 입력</a>
										</div>
									</td>
									<td>
										<div class="adminContent_order">
											<a href="javascript:void(0);" class="check_btn" onclick="modal_popup(${datas[i].id});">주문서 내역</a>
										</div>
									</td>
								</tr>`;

				tag2 += `
								<div class="adminModal_ok adminModal_order" style="width: 500px;">
									<h3 style="border-bottom: none;">주문서 내역</h3>
									<div>
										<table class="adminModal_order_table">
										   <colgroup>
											 <col width="50%">
											 <col width="*">
										   </colgroup>
										   <tbody>
												<tr>
													<th>상품명</th>
													<td id="order_view_product_name">${product['data'].product_name}</td>
												</tr>
												<tr>
													<th>옵션</th>
													<td id="order_view_option">S/노랑</td>
												</tr>
												<tr>
													<th>수량</th>
													<td id="order_view_product_count">${datas[i].count}</td>
												</tr>
												<tr>
													<th>판매가</th>
													<td id="order_view_price">${datas[i].product_price.toLocaleString('ko-KR')}원</td>
												</tr>
												<tr>
													<th>배송료</th>
													<td id="order_view_delivery_fee">${datas[i].delivery_fee.toLocaleString('ko-KR')}원</td>
												</tr>
												<tr>
													<th>셀러이름</th>
													<td id="order_view_seller_name"></td>
												</tr>
												<tr>
													<th>구매날짜</th>
													<td id="order_view_sell_date">${formattedTime}</td>
												</tr>
												<tr>
													<th>구매자명</th>
													<td id="order_view_sell_name">${datas[i].name}</td>
												</tr>
												<tr>
													<th>주소</th>
													<td id="order_view_addr">${datas[i].address1} ${datas[i].address2}</td>
												</tr>
												<tr>
													<th>송장번호</th>
													<td id="order_view_invoice_num">${datas[i].invoice_number}</td>
												</tr>
										   </tbody>
										</table>
										
									</div>
									<div class="adminModal_ok_btn">
										<a href="javascript:void(0);" class="ok_btn modalClose" id="close_btn">확인</a>
									</div>
								</div>
							`;

						$("#modal").append(tag2);
		}

		
		//$("#order_count_new").find('span').text(order_count_new);
		//$("#order_count_ready").find('span').text(order_count_ready);
		//$("#order_count_paid").find('span').text(order_count_paid);
		//$("#order_count_deli_ready").find('span').text(order_count_deli_ready);
		//$("#order_count_deli_complete").find('span').text(order_count_deli_complete);
		//$("#order_count_all").find('span').text(datas.length);
		
		$("#order_load_tbody").html(tag);

	}

	function order_load(){
		$.ajax({
			type : "GET",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/orders_by_seller?seller_id="+"1",      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				// 응답코드 > 0000
				console.log(res);
				orders = res;
				orders_origin = res;
				
				var tmp_arr = orders_origin.filter(function(order_info){
					return order_info.statusStr == "ready";//To Do 신규 주문으로 변경 처리
				})

				var tmp_arr2 = orders_origin.filter(function(order_info){
					return order_info.statusStr == "ready";
				})

				var tmp_arr3 = orders_origin.filter(function(order_info){
					return order_info.statusStr == "paid";
				})

				var tmp_arr4 = orders_origin.filter(function(order_info){
					return order_info.statusStr == "readyForDelivery";
				})

				var tmp_arr5 = orders_origin.filter(function(order_info){
					return order_info.statusStr == "sended";
				})

				
				$(".order_count_new_span").text(tmp_arr2.length);//To Do 신규 주문으로 변경 처리
				$(".order_count_ready_span").text(tmp_arr2.length);
				$(".order_count_paid_span").text(tmp_arr3.length);
				$(".order_count_deli_ready_span").text(tmp_arr4.length);
				$(".order_count_deli_complete_span").text(tmp_arr5.length);
				$(".order_count_all_span").text(orders_origin.length);

				$('#paging').pagination({
					dataSource: orders,
					callback: function(data, pagination) {
						load_order_list(data);
					}
				});
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.")
			}
		});
	}
	
	function product_load(id){
		
		var myObject = new Object();

		$.ajax({
			type : "GET",            // HTTP method type(GET, POST) 형식이다.
			async: false,
			url : "http://43.200.169.89/retail_product-detail?product_id="+id,      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				myObject['data'] = res[0];
				products = res;
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.");
			}
		});
		//console.log(myObject);
		return myObject;
	}
	
	function invoice_save(){
		var delivery_company_name = $("select[name=delivery_company_name]").val();
		var invoice_number = $("input[name=invoice_number]").val();
		var invoice_id = $("input[name=invoice_id]").val();
		console.log(delivery_company_name);
		$.ajax({
			type : "POST",            // HTTP method type(GET, POST) 형식이다.
			url : "http://43.200.169.89/enroll-invoice",      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				delivery_company_name : delivery_company_name,
				invoice_number : invoice_number,
				order_id : invoice_id,
				enroll_time : enroll_time
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				console.log(res);
				if(res == "success"){
					alert("송장입력이 완료 되었습니다.");
					$("#modal2").hide();
					//category_road();
				}else if(res == "already exist"){
					alert("이미 송장입력이 완료되었습니다.");
					$("#modal2").hide();
					//category_road();already exist
				}else{
					alert("오류 발생. 관리자에게 문의하세요.");
				}
			
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.");
			}
		});
	}

	function invoice_load(id){
		
		var myObject = new Object();

		$.ajax({
			type : "GET",            // HTTP method type(GET, POST) 형식이다.
			async: false,
			url : "http://43.200.169.89/invoice-info?order_id="+id,      // 컨트롤러에서 대기중인 URL 주소이다.
			data : {
				},            // Json 형식의 데이터이다.
			success : function(res){ // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
				console.log(res);
				myObject['data'] = res[0];
			},
			error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
				alert("통신 실패.");
			}
		});
		console.log('myObject',myObject);
		return myObject;
	}

	$(".order_count_new").click(function(e){
		
		$("input[name=search_order]").val('');

		orders = orders_origin.filter(function(order_info){
			return order_info.statusStr == "ready";//To Do 신규 주문으로 변경 처리
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})

	$(".order_count_ready").click(function(e){
		
		$("input[name=search_order]").val('');

		orders = orders_origin.filter(function(order_info){
			return order_info.statusStr == "ready";
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})

	$(".order_count_paid").click(function(e){
		
		$("input[name=search_order]").val('');

		orders = orders_origin.filter(function(order_info){
			return order_info.statusStr == "paid";
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})

	$(".order_count_deli_ready").click(function(e){
		
		$("input[name=search_order]").val('');

		orders = orders_origin.filter(function(order_info){
			return order_info.statusStr == "readyForDelivery";
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})

	$(".order_count_deli_complete").click(function(e){
		
		$("input[name=search_order]").val('');

		orders = orders_origin.filter(function(order_info){
			return order_info.statusStr == "sended";
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})
	
	$(".order_count_all").click(function(e){
		
		$("input[name=search_order]").val('');

		$('#paging').pagination({
			dataSource: orders_origin,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});

		$(this).addClass("active");
		$(this).siblings().removeClass("active");

	})

	$(".search_btn").click(function(e){ //To Do API 변경되면 검색 테스트
		var search_word = $("input[name=search_order]").val();
		
		orders = orders_origin.filter(function(order_info){
			return order_info.product_name.indexOf(search_word) > -1;
		})

		$('#paging').pagination({
			dataSource: orders,
			callback: function(data, pagination) {
				load_order_list(data);
			}
		});
	})
	
	function enterkey(){
		if (window.event.keyCode == 13) { //To Do API 변경되면 검색 테스트
			var search_word = $("input[name=search_order]").val();
		
			orders = orders_origin.filter(function(order_info){
				return order_info.product_name.indexOf(search_word) > -1;
			})

			$('#paging').pagination({
				dataSource: orders,
				callback: function(data, pagination) {
					load_order_list(data);
				}
			});
		}
	}
	 
</script>
